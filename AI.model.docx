import pandas as pd
import re
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, classification_report, confusion_matrix
import joblib

# ====================== 1. Dataset yükləmə ======================
df = pd.read_excel("test.xlsx")          # ← fayl adını dəyişdirsən dəyiş
print("Dataset ölçüsü:", df.shape)
print(df.head())

# Label paylanması
print("\nLabel paylanması:\n", df['label'].value_counts())

emotion_map = {0: "sadness", 1: "joy", 2: "love", 
               3: "anger", 4: "fear", 5: "surprise"}
df['emotion'] = df['label'].map(emotion_map)

# EDA plot
plt.figure(figsize=(8,5))
sns.countplot(x='emotion', data=df)
plt.title("Emotion paylanması")
plt.xticks(rotation=45)
plt.show()

# ====================== 2. Text Cleaning ======================
def clean_text(text):
    if not isinstance(text, str):
        return ""
    text = text.lower()
    text = re.sub(r'http\S+', '', text)           # linklər
    text = re.sub(r'@\w+', '', text)              # mention
    text = re.sub(r'#', '', text)
    text = re.sub(r'[^\w\s]', '', text)           # punctuation
    text = re.sub(r'\d+', '', text)               # rəqəmlər
    text = re.sub(r'\s+', ' ', text).strip()
    return text

df['clean_text'] = df['text'].apply(clean_text)
df = df[df['clean_text'].str.strip() != ''].copy()

print("\nTəmizlənmiş nümunələr:")
print(df[['text', 'clean_text', 'emotion']].head(10))

# ====================== 3. Model qurma ======================
X = df['clean_text']
y = df['label']

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

vectorizer = TfidfVectorizer(max_features=12000, ngram_range=(1,2), min_df=2)
X_train_tfidf = vectorizer.fit_transform(X_train)
X_test_tfidf  = vectorizer.transform(X_test)

model = LogisticRegression(max_iter=1000, multi_class='multinomial', 
                           class_weight='balanced', random_state=42)
model.fit(X_train_tfidf, y_train)

# ====================== 4. Qiymətləndirmə ======================
y_pred = model.predict(X_test_tfidf)
print("\nAccuracy:", round(accuracy_score(y_test, y_pred), 4))
print("\nClassification Report:")
print(classification_report(y_test, y_pred, target_names=list(emotion_map.values())))

# Confusion Matrix
cm = confusion_matrix(y_test, y_pred)
plt.figure(figsize=(7,6))
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues',
            xticklabels=emotion_map.values(),
            yticklabels=emotion_map.values())
plt.title("Confusion Matrix")
plt.xlabel("Proqnoz")
plt.ylabel("Real")
plt.show()

# ====================== 5. Proqnoz funksiyası ======================
def predict_emotion(sentence):
    cleaned = clean_text(sentence)
    vec = vectorizer.transform([cleaned])
    pred = model.predict(vec)[0]
    prob = model.predict_proba(vec)[0].max()
    return emotion_map[pred], round(prob, 4)

# Nümunə test cümlələri (hər sinifdən bir)
test_sentences = [
    "I feel so sad and lonely today",                                      # 0 sadness
    "Today is the best day ever, I'm so happy!",                           # 1 joy
    "I really love spending time with my family",                          # 2 love
    "I'm so angry right now, this is unfair!",                             # 3 anger
    "I'm scared of what will happen tomorrow",                             # 4 fear
    "Wow! I can't believe I won the prize!"                                # 5 surprise
]

print("\n=== Test nəticələri ===")
for s in test_sentences:
    duygu, ehtimal = predict_emotion(s)
    print(f"Cümlə: {s}\n→ {duygu} (ehtimal: {ehtimal})\n")

# Modeli saxla
joblib.dump(model, 'emotion_model.pkl')
joblib.dump(vectorizer, 'tfidf_vectorizer.pkl')
print("Model və vectorizer saxlandı!")
# ====================== Gradio interfeysi (optional, amma tapşırıqda qeyd olunub) ======================
try:
    import gradio as gr

    def gradio_predict(text):
        if not text.strip():
            return "Zəhmət olmasa bir cümlə yazın."
        
        emotion, prob = predict_emotion(text)
        return f"**Duyğu: {emotion}**\nEhtimal: {prob:.2%}"

    # Gradio interfeysi
    iface = gr.Interface(
        fn=gradio_predict,
        inputs=gr.Textbox(
            lines=3,
            placeholder="Buraya öz cümlənizi yazın (məsələn: I feel so happy today!)",
            label="Cümlə daxil edin"
        ),
        outputs=gr.Markdown(),
        title="Emotion (Duyğu) Təyinedici",
        description="Model 6 emosiyanı tanıyır: sadness, joy, love, anger, fear, surprise",
        examples=[
            ["I feel so sad and lonely today"],
            ["Today is the best day ever, I'm so happy!"],
            ["I'm really angry right now!"],
            ["I'm scared of what will happen tomorrow"],
            ["Wow! I can't believe I won!"],
            ["I love spending time with you so much"]
        ],
        theme="soft"  # gözəl görünüş üçün
    )

    print("\nGradio serveri işə salınır... Brauzerdə http://127.0.0.1:7860 açılacaq.")
    iface.launch(share=False)  # share=True etsən publik link verər (amma diqqətli ol)

except ImportError:
    print("Gradio quraşdırılmayıb. Quraşdırmaq üçün: pip install gradio")
except Exception as e:
    print(f"Gradio işə salınarkən xəta: {e}")